<?php
 use Tygh\Enum\AffiliateUserTypes; use Tygh\Languages\Languages; use Tygh\Enum\ImagePairTypes; use Tygh\Enum\BannerTypes; use Tygh\Enum\BannerLinkTypes; function fn_settings_actions_addons_sd_affiliate_aff_banner_multilang($new_value, $old_value) { if ($new_value == 'N') { $lang_codes = Languages::getAll(); unset($lang_codes[DEFAULT_LANGUAGE]); $banners_multilang = []; foreach ($lang_codes as $lang_code => $lang_data) { $banners = sd_MTBmNWI1NWUwYzhlMTc3YjljNDU0Yjkx(BannerTypes::GRAPHICS, [], false, $lang_code); foreach ($banners as $banner) { $banners_multilang[$lang_code][$banner['banner_id']] = $banner; } } $banners = sd_MTBmNWI1NWUwYzhlMTc3YjljNDU0Yjkx(BannerTypes::GRAPHICS, [], false, DEFAULT_LANGUAGE); foreach ($banners as $banner) { if ($banner['type'] != BannerTypes::GRAPHICS) { continue; } $main_image_id = !empty($banner['main_pair']['image_id']) ? $banner['main_pair']['image_id'] : 0; foreach ($lang_codes as $lang_code => $lang_data) { $banner_lang = $banners_multilang[$lang_code][$banner['banner_id']]; $lang_image_id = !empty($banner_lang['main_pair']['image_id']) ? $banner_lang['main_pair']['image_id'] : 0; if ($lang_image_id != 0 && ($main_image_id == 0 || $main_image_id != $lang_image_id)) { fn_delete_image($lang_image_id, $banner_lang['main_pair']['pair_id'], 'aff_images'); $lang_image_id = 0; } if ($lang_image_id == 0 && $main_image_id != 0) { $data_banner_image = [ 'banner_id' => $banner['banner_id'], 'lang_code' => $lang_code ]; db_query( 'DELETE FROM ?:aff_banner_images' . ' WHERE banner_id = ?i AND lang_code = ?s', $banner['banner_id'], $lang_code ); $banner_image_id = db_query('INSERT INTO ?:aff_banner_images ?e', $data_banner_image); fn_add_image_link($banner_image_id, $banner['main_pair']['pair_id']); $data_desc = [ 'description' => empty($banner['main_pair']['icon']['alt']) ? '' : $banner['main_pair']['icon']['alt'], 'object_holder' => 'images' ]; fn_create_description('common_descriptions', 'object_id', $main_image_id, $data_desc); } } } } return true; } 