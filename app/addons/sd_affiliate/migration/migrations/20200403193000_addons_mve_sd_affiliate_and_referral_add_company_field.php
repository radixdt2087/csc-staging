<?php
 use Phinx\Migration\AbstractMigration; class AddonsMveSdAffiliateAndReferralAddCompanyField extends AbstractMigration { protected $addon_id = 'sd_affiliate'; public function up() { $options = $this->adapter->getOptions(); $this->prefix = $options['prefix']; $addon = $this->fetchRow( "SELECT addon FROM {$this->prefix}addons" . " WHERE addon = '{$this->addon_id}'" ); if (empty($addon)) { return; } if ($this->hasTable("{$this->prefix}affiliate_plans")) { $table = $this->table("{$this->prefix}affiliate_plans"); if (!$table->hasColumn('company_ids')) { $table->addColumn( 'company_ids', 'text', ['signed' => false, 'null' => false, 'after' => 'product_ids'] )->update(); } $table->save(); } $langvars = [ 'sd_affilate.linked_vendors' => [ 'en' => 'Linked vendors', 'ru' => 'Связанные поставщики' ], 'sd_affilate.vendors' => [ 'en' => 'Vendors', 'ru' => 'Поставщики' ], 'affiliate.payout_sales_note' => [ 'en' => 'Note: The priority of applying the commission value for orders will be Product > Category > General payout sales. If the sales commission is specified in this tab, this value will be used to calculate the Payout sales commission for the affiliate unless another value is specified in the <b>Products</b> or <b>Categories</b> tab.', 'ru' => 'Приоритет выбора комиссии для заказов следующий: Товар -> Категория -> Общие выплаты по продажам. Значение комиссии в этом поле будет использоваться для расчета комиссии за продажу для партнера, если на вкладке <b>Товары</b> или <b>Категории</b> не указано никакое значение.' ], 'affiliate.products_note' => [ 'en' => 'Note: The priority of applying the commission value for orders will be Product > Category > General payout sales. If the sales commission is specified for a product in this tab, this value will be used to calculate the Payout sales commission for the affiliate.', 'ru' => 'Примечание. Приоритет выбора комиссии для заказов следующий: Товар -> Категория -> Общие выплаты по продажам. Если для продукта на этой вкладке указана комиссия за продажу, это значение будет использоваться для расчета комиссии за продажу для партнера.' ], 'affiliate.categories_note' => [ 'en' => 'Note: The priority of applying the commission value for orders will be Product > Category > General payout sales. If the sales commission is specified for a category in this tab, this value will be used to calculate the Payout sales commission for the affiliate unless another value is specified in the <b>Products</b> tab.', 'ru' => 'Примечание. Приоритет выбора комиссии для заказов следующий: Товар -> Категория -> Общие выплаты по продажам. Значение комиссии на этой вкладке будет использоваться для расчета комиссии за продажу для партнера, если на вкладке <b>Товары</b> не указано другое значение.' ], 'affiliate.payout_sales_note_mv' => [ 'en' => 'Note: The priority of applying the commission value for orders will be Product > Category > Vendor > General payout sales. If the sales commission is specified in this tab, this value will be used to calculate the Payout sales commission for the affiliate unless another value is specified in the <b>Products</b>, <b>Categories</b> or <b>Vendors</b> tab.', 'ru' => 'Приоритет выбора комиссии для заказов следующий: Товар -> Категория -> Продавец -> Общие выплаты по продажам. Значение комиссии в этом поле будет использоваться для расчета комиссии за продажу для партнера, если на вкладке <b>Товары</b>, <b>Категории</b> или <b>Поставщики</b> не указано никакое значение.' ], 'affiliate.products_note_mv' => [ 'en' => 'Note: The priority of applying the commission value for orders will be Product > Category > Vendor > General payout sales. If the sales commission is specified for a product in this tab, this value will be used to calculate the Payout sales commission for the affiliate.', 'ru' => 'Примечание. Приоритет выбора комиссии для заказов следующий: Товар -> Категория -> Продавец -> Общие выплаты по продажам. Если для продукта на этой вкладке указана комиссия за продажу, это значение будет использоваться для расчета комиссии за продажу для партнера.' ], 'affiliate.categories_note_mv' => [ 'en' => 'Note: The priority of applying the commission value for orders will be Product > Category > Vendor > General payout sales. If the sales commission is specified for a category in this tab, this value will be used to calculate the Payout sales commission for the affiliate unless another value is specified in the <b>Products</b> tab.', 'ru' => 'Примечание. Приоритет выбора комиссии для заказов следующий: Товар -> Категория -> Продавец -> Общие выплаты по продажам. Значение комиссии на этой вкладке будет использоваться для расчета комиссии за продажу для партнера, если на вкладке <b>Товары</b> не указано другое значение.' ], 'affiliate.vendors_note' => [ 'en' => 'Note: The priority of applying the commission value for orders will be Product > Category > Vendor > General payout sales. If the sales commission is specified for a vendor in this tab, this value will be used to calculate the Payout sales commission for the affiliate unless another value is specified in the <b>Products</b> or <b>Categories</b> tab.', 'ru' => 'Примечание. Приоритет выбора комиссии для заказов следующий: Товар -> Категория -> Продавец -> Общие выплаты по продажам. Значение комиссии на этой вкладке будет использоваться для расчета комиссии за продажу для партнера, если на вкладке <b>Товары</b> или <b>Категории</b> не указано другое значение.' ], ]; $this->addOrUpdateLangvars($langvars); } public function down() { } protected function addOrUpdateLangvars($langvars) { foreach ($langvars as $langvar_name => $langvar_values) { foreach ($langvar_values as $lang_code => $langvar_value) { $data = [ 'lang_code' => $lang_code, 'name' => $langvar_name, 'value' => $langvar_value ]; $value = $this->fetchRow( "SELECT value FROM {$this->prefix}language_values" . " WHERE name = '{$data['name']}' AND lang_code = '{$data['lang_code']}'" ); if (empty($value)) { list($fields, $values) = $this->prepareForInsert($data); $this->execute("INSERT INTO {$this->prefix}language_values ({$fields}) VALUES ({$values})"); } else { $this->execute("UPDATE {$this->prefix}language_values" . " SET value = '{$data['value']}'" . " WHERE name = '{$data['name']}' AND lang_code = '{$data['lang_code']}'"); } } } } protected function prepareForInsert($data) { $data = array_map('addslashes', $data); $fields = implode(', ', array_keys($data)); $values = sprintf("'%s'", implode("', '", $data)); return [$fields, $values]; } } 