<?php
 use Tygh\Registry; use Tygh\Enum\BannerTypes; use Tygh\Enum\BannerLinkTypes; defined('BOOTSTRAP') or die('Access denied'); if ($mode == 'view') { $cart = &Tygh::$app['session']['cart']; if (!empty($_REQUEST['bid'])) { $banner = sd_OTMzMzY4NmVjZTkyODA0OTA1MjI4NDlm($_REQUEST['bid'], CART_LANGUAGE, true); $banner_correct = true; if (empty($banner) || $banner['status'] == 'D') { return [CONTROLLER_STATUS_REDIRECT, fn_url()]; } $partner_id = fn_get_cookie('partner_id'); if (!empty($banner['banner_id']) && !empty($_REQUEST['aff_id']) && Tygh::$app['session']['auth']['user_id'] == 0 && empty($partner_id) ) { Tygh::$app['session']['partner_data'] = [ 'banner_id' => $banner['banner_id'], 'partner_id' => $_REQUEST['aff_id'], 'is_payouts' => 'N', 'product_id' => @$_REQUEST['product_id'], ]; } if (!empty($banner['type']) && $banner['type'] == BannerTypes::PRODUCTS) { if (!empty($_REQUEST['product_id'])) { if (!empty($banner['to_cart']) && $banner['to_cart'] == 'Y') { if (empty($cart)) { fn_clear_cart($cart); } fn_add_product_to_cart([ $_REQUEST['product_id'] => [ 'product_id' => $_REQUEST['product_id'], 'amount' => 1, ], ], $cart, $auth); fn_save_cart_content($cart, $auth['user_id']); $cart['change_cart_products'] = true; fn_calculate_cart_content($cart, $auth, 'S', true, 'F', true); $redirect_url = 'checkout.cart'; } else { $redirect_url = "products.view?product_id=$_REQUEST[product_id]"; } } else { $banner_correct = false; $banner['type'] = BannerTypes::TEXT; $banner['link_to'] = BannerLinkTypes::URL; $banner['url'] = Registry::get('config.http_location'); } } if (!empty($banner['link_to']) && $banner['type'] != BannerTypes::PRODUCTS) { $link_to = $banner['link_to']; $data = &$banner; if ($link_to == BannerLinkTypes::PRODUCT_GROUPS && !empty($banner['group_id'])) { $group = sd_NTAzY2FlNTk4M2U0NmExMDRhMWUwN2Rl($banner['group_id'], true); if (empty($group) || $group['status'] == 'D') { return [CONTROLLER_STATUS_REDIRECT, fn_url()]; } $link_to = @$group['link_to']; if (!empty($group['product_ids'])) { $group['products'] = fn_get_product_name($group['product_ids']); } $data = &$group; } elseif ($link_to == BannerLinkTypes::PRODUCT_GROUPS && empty($banner['group_id'])) { return [CONTROLLER_STATUS_REDIRECT, fn_url()]; } if ($link_to == BannerLinkTypes::URL) { $redirect_url = empty($data['url']) ? '' : $data['url']; } elseif ($link_to == BannerLinkTypes::PRODUCTS) { if (empty($data['products'])) { $data['products'] = []; } if (count($data['products']) == 1) { $redirect_url = 'products.view?product_id=' . key($data['products']); } $not_redirect = 'Y'; $selected_layout = fn_get_products_layout($_REQUEST); $products = []; $search = []; if (!empty($data['products'])) { $params = $_REQUEST; $params['pid'] = array_keys($data['products']); $params['extend'] = ['description']; list($products, $search) = fn_get_products( $params, Registry::get('settings.Appearance.products_per_page') ); fn_gather_additional_products_data($products, ['get_icon' => true, 'get_detailed' => true]); } Tygh::$app['view']->assign([ 'products' => $products, 'search' => $search, 'selected_layout' => $selected_layout ]); } elseif ($link_to == BannerLinkTypes::CATEGORIES) { if (!empty($data['categories']) && is_array($data['categories'])) { $first_category_id = key($data['categories']); if (count($data['categories']) == 1 && !empty($first_category_id)) { $b_categories = []; $redirect_url = 'categories.view?category_id=' . key($data['categories']); } else { $b_categories = []; foreach ($data['categories'] as $category_id => $category_name) { $b_categories[$category_id] = fn_get_category_data($category_id, CART_LANGUAGE); } $not_redirect = 'Y'; } unset($first_category_id); } else { $b_categories = []; } Tygh::$app['view']->assign('banner_categories', $b_categories); } } if ((!empty($redirect_url) || !empty($not_redirect)) && !empty($banner['banner_id']) && !empty($_REQUEST['aff_id']) && $banner_correct ) { sd_OWQzMGUwNzVkM2VlN2Y5MGIyN2Q4ZGYy( 'click', $banner['banner_id'], $_REQUEST['aff_id'], $auth['user_id'], ['R' => !empty($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : ''] ); } if (!empty($redirect_url)) { return [CONTROLLER_STATUS_REDIRECT, $redirect_url, true]; } } } 