<?php
 use Tygh\Registry; use Tygh\Enum\AffiliateUserTypes; defined('BOOTSTRAP') or die('Access denied'); if ($mode == 'html_file') { $_tout = 5; if (empty($action)) { $action = 'partner'; } $_rurl = ($action == 'partner') ? fn_url('profiles.add?aff_id=' . $auth['user_id']) : (fn_url('') . "?aff_id={$auth['user_id']}"); $_u_data = fn_get_user_info($auth['user_id']); $_u_name = empty($_u_data['firstname']) ? '' : $_u_data['firstname']; $_u_name .= (empty($_u_name) || empty($_u_data['lastname'])) ? '' : ' '; $_u_name .= empty($_u_data['lastname']) ? '' : $_u_data['lastname']; Tygh::$app['view']->assign('_tout', $_tout); Tygh::$app['view']->assign('_rurl', $_rurl); Tygh::$app['view']->assign('_u_name', $_u_name); $file_content = trim(Tygh::$app['view']->fetch('affiliate/redirect.tpl')); header("Content-type: text/html"); header("Content-disposition: attachment; filename=$action.html"); echo $file_content; exit(); } if (empty($auth['user_id'])) { return [CONTROLLER_STATUS_DENIED]; } fn_add_breadcrumb(__('affiliates_partnership'), 'affiliate_plans.list'); if ($auth['user_type'] == AffiliateUserTypes::PARTNER){ $affiliate_plan = sd_OTljYTYwM2ExM2Q5MjM3MzAwNzA0NDYw($auth['user_id']); Tygh::$app['view']->assign('commission_rates_title', __('sd_affiliate.commission_rates')); } elseif ($auth['user_type'] == AffiliateUserTypes::CUSTOMER) { $affiliate_plan = sd_ZDU3OGQxNDE3MGNjZGJjMjkyMzdmN2Vj($auth['user_id']); Tygh::$app['view']->assign('commission_rates_title', __('addons.sd_affiliate.commission_rates_in_reward_points')); } if (!empty($affiliate_plan['plan_id'])) { $show_commissions_rates = false; foreach ($affiliate_plan['payout_types'] as $payout_type) { if ($payout_type['value'] > 0) { $show_commissions_rates = true; } } $affiliate_plan['min_payment'] = floatval($affiliate_plan['min_payment']); $linked_products = []; foreach ($affiliate_plan['product_ids'] as $prod_id => $sale) { $linked_products[$prod_id] = fn_get_product_data($prod_id, $auth); $linked_products[$prod_id]['sale'] = $sale; } $linked_categories = []; foreach ($affiliate_plan['category_ids'] as $cat_id => $sale) { $linked_categories[$cat_id]['category'] = fn_get_category_name($cat_id, CART_LANGUAGE); $linked_categories[$cat_id]['category_id'] = $cat_id; $linked_categories[$cat_id]['sale'] = $sale; } $linked_vendors = []; foreach ($affiliate_plan['company_ids'] as $vend_id => $sale) { $linked_vendors[$vend_id]['company'] = fn_get_company_name($vend_id, DESCR_SL); $linked_vendors[$vend_id]['company_id'] = $vend_id; $linked_vendors[$vend_id]['sale'] = $sale; } if (!empty($affiliate_plan['promotion_ids'])) { Tygh::$app['view']->assign( 'coupons', sd_OGQyODdkNGJmMDY2MmFmNjg3YmMzZGRl($affiliate_plan['promotion_ids'], $auth) ); } $custom_affiliate_parameter_setting = Registry::get('addons.sd_affiliate.custom_affiliate_parameter'); $general_affiliate_parameter = !empty($custom_affiliate_parameter_setting) ? $custom_affiliate_parameter_setting : ''; $custom_affiliate_parameter = sd_NjIxNWQ3YzM3ZTMzZTFiNDgxYmIxMTAx($auth['user_id']); $aff_url_to_homepage = ''; if (!empty($general_affiliate_parameter) && !empty($custom_affiliate_parameter)) { $aff_url_to_homepage = fn_get_storefront_url(fn_get_storefront_protocol()) . '/' . $general_affiliate_parameter . '/' . $custom_affiliate_parameter; } Tygh::$app['view']->assign([ 'linked_products' => $linked_products, 'linked_categories' => $linked_categories, 'linked_vendors' => $linked_vendors, 'show_commissions_rates' => $show_commissions_rates, 'affiliate_plan' => $affiliate_plan, 'payout_types' => Registry::get('payout_types'), 'aff_url_to_homepage' => $aff_url_to_homepage, 'general_affiliate_parameter' => $general_affiliate_parameter, 'aff_coupon_code' => sd_NzJhMDI2ZjJlNDk3MjBmNzI1N2JlNTUz($auth['user_id']) ]); } 