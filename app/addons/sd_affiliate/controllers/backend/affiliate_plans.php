<?php
 use Tygh\Registry; use Tygh\Enum\UserStatuses; use Tygh\Enum\AffiliateUserTypes; defined('BOOTSTRAP') or die('Access denied'); if ($_SERVER['REQUEST_METHOD'] == 'POST') { fn_trusted_vars('add_affiliate_plans', 'affiliate_plans_data', 'affiliate_plan', 'levels', 'commissions_ids'); $suffix = ''; if ($mode == 'm_delete') { if (fn_allowed_for('ULTIMATE')) { if (Registry::get('runtime.company_id')) { $plan_ids = !empty($_REQUEST['plan_id']) ? ((array) $_REQUEST['plan_id']) : $_REQUEST['plan_ids']; foreach ($plan_ids as $key => $plan_id) { $plan_company_id = db_get_field('SELECT company_id FROM ?:affiliate_plans WHERE plan_id = ?i', $plan_id); if ($plan_company_id != Registry::get('runtime.company_id')) { fn_set_notification('E', __('error'), __('aff_object_cant_delete')); if (!empty($_REQUEST['plan_id'])) { unset($_REQUEST['plan_id']); } else { unset($_REQUEST['plan_ids'][$key]); } } } } } if (!empty($_REQUEST['plan_ids'])) { sd_OGNkZDc3ZWRiZTkwNmQzZTFkMjg2NzJk($_REQUEST['plan_ids']); $suffix = '.manage'; return [CONTROLLER_STATUS_OK, "affiliate_plans$suffix"]; } if (!empty($_REQUEST['plan_id']) && !empty($_REQUEST['selected_section'])) { if (!empty($_REQUEST['affiliate_plan']['commission_ids']) && $_REQUEST['selected_section'] == 'multi_tier_affiliates' ) { $plan_id = sd_YTcxOTcyZGEyODJmNDAxMGNiZWNhNTNl($_REQUEST['affiliate_plan']['commission_ids'], $_REQUEST['plan_id']); } elseif (!empty($_REQUEST['affiliate_plan']['product_ids']) && $_REQUEST['selected_section'] == 'linked_products' ) { $plan_id = sd_Y2RjZGQyMDE1OTc1YzdhOGVlNWVmZjRj($_REQUEST['affiliate_plan']['product_ids'], $_REQUEST['plan_id']); } elseif (!empty($_REQUEST['affiliate_plan']['category_ids']) && $_REQUEST['selected_section'] == 'linked_categories' ) { $plan_id = sd_ZjNmZmFhNTg3NGIyNTkzYWNlZjZlM2E3($_REQUEST['affiliate_plan']['category_ids'], $_REQUEST['plan_id']); } elseif (!empty($_REQUEST['affiliate_plan']['promotion_ids']) && $_REQUEST['selected_section'] == 'coupons' ) { $plan_id = sd_NGIwYWU3MjVkOTZmZWRjNmNhMmE1MzQ1($_REQUEST['affiliate_plan']['promotion_ids'], $_REQUEST['plan_id']); } elseif (fn_allowed_for('MULTIVENDOR') &&!empty($_REQUEST['affiliate_plan']['company_ids']) && $_REQUEST['selected_section'] == 'linked_vendors' ) { $plan_id = sd_ZGZjNjk4MGMyYWEzYWQ4NzIyNjlmYjVh($_REQUEST['affiliate_plan']['company_ids'], $_REQUEST['plan_id']); } } $suffix = ".update?plan_id=$_REQUEST[plan_id]"; } if ($mode == 'update') { $plan_id = sd_NzU3MTY2N2M4OTk5ZWY1YmFmZjExMTY1($_REQUEST['affiliate_plan'], $_REQUEST['plan_id'], DESCR_SL); if (fn_allowed_for('ULTIMATE')) { sd_NTg0NmM4OTU4ZTEzODkwYTBiZWNhYjky($_REQUEST); } $plan_type = $_REQUEST['affiliate_plan']['plan_type']; $suffix = ".update?plan_id=$plan_id&plan_type=$plan_type"; if (!empty($_REQUEST['return_to_list'])) { $_REQUEST['redirect_url'] = 'affiliate_plans.manage?plan_type=' . $plan_type; } } if ($mode == 'add_commissions') { if (!empty($_REQUEST['levels'])) { $plan_data = sd_Y2M5OWY4ZDllM2MyODUxM2Q1N2VjYjA3($_REQUEST['plan_id'], DESCR_SL); if (!empty($plan_data)) { foreach ($_REQUEST['levels'] as $level_data) { if (!empty($level_data['commission'])) { $level_data['commission'] = floatval($level_data['commission']); $level_data['commission'] = ($level_data['commission'] > 100) ? 100 : (($level_data['commission'] < 0) ? 0 : $level_data['commission'] ); $plan_data['commissions'][] = $level_data['commission']; } } $plan_id = sd_NzU3MTY2N2M4OTk5ZWY1YmFmZjExMTY1($plan_data, $_REQUEST['plan_id'], DESCR_SL); } } $suffix = ".update?plan_id=$plan_id&selected_section=multi_tier_affiliates"; } if ($mode == 'add_products') { if (!empty($_REQUEST['plan_id']) && !empty($_REQUEST['add_products_ids'])) { $plan_data = sd_Y2M5OWY4ZDllM2MyODUxM2Q1N2VjYjA3($_REQUEST['plan_id'], DESCR_SL); $products_ids = $plan_data['product_ids']; if (empty($products_ids)) { $products_ids = []; } foreach ($_REQUEST['add_products_ids'] as $prod_id) { if (!isset($products_ids[$prod_id])) { $products_ids[$prod_id] = $plan_data['payout_types']['sale']; } } $plan_data['product_ids'] = $products_ids; $plan_id = sd_NzU3MTY2N2M4OTk5ZWY1YmFmZjExMTY1($plan_data, $_REQUEST['plan_id'], DESCR_SL); } $suffix = ".update?plan_id=$plan_id"; } if ($mode == 'add_companies') { if (fn_allowed_for('MULTIVENDOR') && !empty($_REQUEST['plan_id']) && !empty($_REQUEST['companies_ids'])) { $plan_data = sd_Y2M5OWY4ZDllM2MyODUxM2Q1N2VjYjA3($_REQUEST['plan_id'], DESCR_SL); $company_ids = $plan_data['company_ids']; if (empty($company_ids)) { $company_ids = []; } foreach ($_REQUEST['companies_ids'] as $company_id) { if (!isset($company_ids[$company_id])) { $company_ids[$company_id] = $plan_data['payout_types']['sale']; } } $plan_data['company_ids'] = $company_ids; $plan_id = sd_NzU3MTY2N2M4OTk5ZWY1YmFmZjExMTY1($plan_data, $_REQUEST['plan_id'], DESCR_SL); } $suffix = ".update?plan_id=$plan_id"; } if ($mode == 'add_categories') { if (!empty($_REQUEST['plan_id']) && !empty($_REQUEST['categories_ids'])) { $plan_data = sd_Y2M5OWY4ZDllM2MyODUxM2Q1N2VjYjA3($_REQUEST['plan_id'], DESCR_SL); $categories_ids = empty($plan_data['category_ids']) ? [] : $plan_data['category_ids']; $add_categories_ids = array_keys($_REQUEST['categories_ids']); foreach ($add_categories_ids as $k => $cat_id) { if (!isset($categories_ids[$cat_id])) { $categories_ids[$cat_id] = $plan_data['payout_types']['sale']; } } $plan_data['category_ids'] = $categories_ids; $plan_id = sd_NzU3MTY2N2M4OTk5ZWY1YmFmZjExMTY1($plan_data, $_REQUEST['plan_id'], DESCR_SL); } $suffix = ".update?plan_id=$plan_id"; } if ($mode == 'add_coupons') { if (!empty($_REQUEST['plan_id']) && !empty($_REQUEST['promotion_ids'])) { $plan_data = sd_Y2M5OWY4ZDllM2MyODUxM2Q1N2VjYjA3($_REQUEST['plan_id'], DESCR_SL); $promotion_ids = $plan_data['promotion_ids']; $add_promotion_ids = $_REQUEST['promotion_ids']; if (empty($promotion_ids)) { $promotion_ids = []; } if (empty($add_promotion_ids)) { $add_promotion_ids = []; } foreach ($add_promotion_ids as $promotion_id) { if (!isset($promotion_ids[$promotion_id])) { $promotion_ids[$promotion_id] = $_REQUEST['coupons'][$promotion_id]; } else { unset($add_promotion_ids[$promotion_id]); } } $plan_data['promotion_ids'] = $promotion_ids; $plan_id = sd_NzU3MTY2N2M4OTk5ZWY1YmFmZjExMTY1($plan_data, $_REQUEST['plan_id'], DESCR_SL); } else { $plan_id = $_REQUEST['plan_id']; } $suffix = ".update?plan_id=$plan_id&selected_section=coupons"; } return [CONTROLLER_STATUS_OK, "affiliate_plans$suffix"]; } if ($mode == 'update') { $plan_type = empty($_REQUEST['plan_type']) ? AffiliateUserTypes::PARTNER : $_REQUEST['plan_type']; $affiliate_plan = sd_Y2M5OWY4ZDllM2MyODUxM2Q1N2VjYjA3($_REQUEST['plan_id'], DESCR_SL); if (!empty($plan_type) && $plan_type == AffiliateUserTypes::CUSTOMER) { Tygh::$app['view']->assign('commission_rates_title', __('addons.sd_affiliate.commission_rates_in_reward_points')); } if (empty($affiliate_plan)) { return [CONTROLLER_STATUS_NO_PAGE]; } if ($plan_type == AffiliateUserTypes::CUSTOMER) { Registry::set('navigation.tabs', [ 'general' => [ 'title' => __('general'), 'js' => true, ] ]); } elseif (fn_allowed_for('MULTIVENDOR')) { Registry::set('navigation.tabs', [ 'general' => [ 'title' => __('general'), 'js' => true, ], 'linked_products' => [ 'title' => __('products'), 'js' => true, ], 'linked_categories' => [ 'title' => __('categories'), 'js' => true, ], 'linked_vendors' => [ 'title' => __('sd_affilate.vendors'), 'js' => true, ], 'multi_tier_affiliates' => [ 'title' => __('multi_tier_affiliates'), 'js' => true, ], ]); } else { Registry::set('navigation.tabs', [ 'general' => [ 'title' => __('general'), 'js' => true, ], 'linked_products' => [ 'title' => __('products'), 'js' => true, ], 'linked_categories' => [ 'title' => __('categories'), 'js' => true, ], 'multi_tier_affiliates' => [ 'title' => __('multi_tier_affiliates'), 'js' => true, ], ]); } $use_multiple_promotions = Registry::get("addons.sd_affiliate.use_multiple_promotions"); if ($use_multiple_promotions == 'Y') { Registry::set('navigation.tabs.coupons', [ 'title' => __('coupons'), 'js' => true, ]); } $linked_products = []; foreach ($affiliate_plan['product_ids'] as $prod_id => $sale) { $linked_products[$prod_id]['product'] = fn_get_product_name($prod_id, DESCR_SL); $linked_products[$prod_id]['sale'] = $sale; } $linked_categories = []; foreach ($affiliate_plan['category_ids'] as $cat_id => $sale) { $linked_categories[$cat_id]['category'] = fn_get_category_name($cat_id, DESCR_SL); $linked_categories[$cat_id]['category_id'] = $cat_id; $linked_categories[$cat_id]['sale'] = $sale; } $linked_vendors = []; foreach ($affiliate_plan['company_ids'] as $company_id => $sale) { $linked_vendors[$company_id]['company'] = fn_get_company_name($company_id, DESCR_SL); $linked_vendors[$company_id]['company_id'] = $company_id; $linked_vendors[$company_id]['sale'] = $sale; } $params = [ 'promotion_id' => empty($affiliate_plan['promotion_ids']) ? ['0' => 0] : array_keys($affiliate_plan['promotion_ids']), ]; list($affiliate_plan['coupons']) = fn_get_promotions($params); foreach ($affiliate_plan['coupons'] as $promotion_id => $coupon_data) { if (isset($affiliate_plan['promotion_ids'][$promotion_id])) { $affiliate_plan['coupons'][$promotion_id]['use_coupon'] = $affiliate_plan['promotion_ids'][$promotion_id]; } } $params = [ 'coupons' => true, ]; list($coupons) = fn_get_promotions($params); foreach (array_keys($affiliate_plan['promotion_ids']) as $promotion_id) { unset($coupons[$promotion_id]); } $payout_types = Registry::get('payout_types'); if ($plan_type == AffiliateUserTypes::CUSTOMER) { foreach ($payout_types as $p_type => $payout_type) { if (!in_array($p_type, ['sale', 'new_customer', 'new_partner', 'new_vendor'])) { unset($payout_types[$p_type]); } } } Tygh::$app['view']->assign([ 'coupons' => $coupons, 'affiliate_plan' => $affiliate_plan, 'payout_types' => $payout_types, 'linked_categories' => $linked_categories, 'linked_products' => $linked_products, 'linked_vendors' => $linked_vendors, 'plan_type' => $plan_type ]); } elseif ($mode == 'add') { $plan_type = empty($_REQUEST['plan_type']) ? AffiliateUserTypes::PARTNER : $_REQUEST['plan_type']; if (!empty($plan_type) && $plan_type == AffiliateUserTypes::CUSTOMER) { Tygh::$app['view']->assign('commission_rates_title', __('addons.sd_affiliate.commission_rates_in_reward_points')); } Registry::set('navigation.tabs', [ 'general' => [ 'title' => __('general'), 'js' => true, ], ]); $payout_types = Registry::get('payout_types'); if ($plan_type == AffiliateUserTypes::CUSTOMER) { foreach ($payout_types as $p_type => $payout_type) { if (!in_array($p_type, ['sale', 'new_customer', 'new_partner', 'new_vendor'])) { unset($payout_types[$p_type]); } } } Tygh::$app['view']->assign([ 'payout_types' => $payout_types, 'plan_type' => $plan_type ]); } elseif ($mode == 'manage') { $plan_type = empty($_REQUEST['plan_type']) ? AffiliateUserTypes::PARTNER : $_REQUEST['plan_type']; list($plans, $search) = sd_MmNiZmRiNmQ3ZWFmODZkZTUwN2ViZDFh( $_REQUEST, Registry::get('settings.Appearance.admin_elements_per_page'), DESCR_SL ); if (Registry::get('addons.sd_affiliate.allow_all_customers_be_affiliates') == 'Y') { Registry::set('navigation.dynamic.sections', [ AffiliateUserTypes::PARTNER => [ 'title' => __('addons.sd_affiliate.super_affiliates_plans'), 'href' => 'affiliate_plans.manage?plan_type=P', ], AffiliateUserTypes::CUSTOMER => [ 'title' => __('addons.sd_affiliate.usual_customers_plan'), 'href' => 'affiliate_plans.manage?plan_type=C', ] ]); Registry::set('navigation.dynamic.active_section', $plan_type); } Tygh::$app['view']->assign([ 'affiliate_plans' => $plans, 'search' => $search, 'plan_type' => $plan_type ]); } elseif ($mode == 'delete') { $plan_type = empty($_REQUEST['plan_type']) ? AffiliateUserTypes::PARTNER : $_REQUEST['plan_type']; if (empty($_REQUEST['plan_id'])) { return [CONTROLLER_STATUS_REDIRECT, 'affiliate_plans.manage&plan_type=' . $plan_type]; } if (fn_allowed_for('ULTIMATE')) { if (Registry::get('runtime.company_id')) { $plan_company_id = db_get_field( 'SELECT company_id' . ' FROM ?:affiliate_plans' . ' WHERE plan_id = ?i', $_REQUEST['plan_id'] ); if ($plan_company_id != Registry::get('runtime.company_id')) { fn_set_notification('E', __('error'), __('aff_object_cant_delete')); return [CONTROLLER_STATUS_REDIRECT, 'affiliate_plans.manage&plan_type=' . $plan_type]; } } } if (isset($_REQUEST['commission_id'])) { $plan_id = sd_YTcxOTcyZGEyODJmNDAxMGNiZWNhNTNl((array) $_REQUEST['commission_id'], $_REQUEST['plan_id']); return [CONTROLLER_STATUS_REDIRECT, "affiliate_plans.update?plan_id=$plan_id&selected_section=multi_tier_affiliates"]; } elseif (isset($_REQUEST['product_id'])) { $plan_id = sd_Y2RjZGQyMDE1OTc1YzdhOGVlNWVmZjRj((array) $_REQUEST['product_id'], $_REQUEST['plan_id']); return [CONTROLLER_STATUS_REDIRECT, "affiliate_plans.update?plan_id=$plan_id&selected_section=linked_products"]; } elseif (isset($_REQUEST['category_id'])) { $plan_id = sd_ZjNmZmFhNTg3NGIyNTkzYWNlZjZlM2E3((array) $_REQUEST['category_id'], $_REQUEST['plan_id']); return [CONTROLLER_STATUS_REDIRECT, "affiliate_plans.update?plan_id=$plan_id&selected_section=linked_categories"]; } elseif (isset($_REQUEST['company_id'])) { $plan_id = sd_ZGZjNjk4MGMyYWEzYWQ4NzIyNjlmYjVh((array) $_REQUEST['company_id'], $_REQUEST['plan_id']); return [CONTROLLER_STATUS_REDIRECT, "affiliate_plans.update?plan_id=$plan_id&selected_section=linked_vendors"]; } elseif (isset($_REQUEST['promotion_id'])) { $plan_id = sd_NGIwYWU3MjVkOTZmZWRjNmNhMmE1MzQ1((array) $_REQUEST['promotion_id'], $_REQUEST['plan_id']); return [CONTROLLER_STATUS_REDIRECT, "affiliate_plans.update?plan_id=$plan_id&selected_section=coupons"]; } else { sd_OGNkZDc3ZWRiZTkwNmQzZTFkMjg2NzJk((array) $_REQUEST['plan_id']); } return [CONTROLLER_STATUS_REDIRECT, 'affiliate_plans.manage&plan_type=' . $plan_type]; } elseif ($mode == 'set_as_default') { sd_OGRkOTNiNWU5ZmZiMjk5YTE0N2IxZWI3($_REQUEST['plan_id']); return [CONTROLLER_STATUS_REDIRECT, 'affiliate_plans.manage&plan_type=' . AffiliateUserTypes::PARTNER]; } 