<?php
 use Tygh\Registry; use Tygh\Enum\UserStatuses; use Tygh\Enum\AffiliateUserTypes; use Tygh\Settings; defined('BOOTSTRAP') or die('Access denied'); if ($_SERVER['REQUEST_METHOD'] == 'POST') { if ($mode == 'update') { if (!empty($_REQUEST['user_data']['user_type']) && $_REQUEST['user_data']['user_type'] == AffiliateUserTypes::PARTNER ) { if (empty($_REQUEST['update_data'])) { return; } if (!empty($_REQUEST['update_data']['approved']) && $_REQUEST['update_data']['approved'] == UserStatuses::NOAPPROVED || $_REQUEST['update_data']['approved'] == UserStatuses::DECLINED ) { $_REQUEST['update_data']['plan_id'] = 0; } sd_MmM0NzU0Njk1OWUwZGYyMDY3MDcyOTBh($_REQUEST['user_id'], $_REQUEST['update_data']); } else { sd_NTgwMGRlMGJiNGM4ZTc5YzNhZmYyNWIz($_REQUEST['user_id']); } return; } } if ($mode == 'update') { if (!empty($_REQUEST['user_type']) && $_REQUEST['user_type'] == AffiliateUserTypes::PARTNER) { $navigation = Registry::get('navigation.tabs'); $navigation['affiliate_information'] = [ 'title' => __('affiliate_information'), 'js' => true, ]; $navigation['affiliate_tree'] = [ 'title' => __('affiliate_tree'), 'js' => true, ]; $navigation['user_affiliate_group'] = [ 'title' => __('affiliate_user_group_title'), 'js' => true, ]; Registry::set('navigation.tabs', $navigation); $partner_data = sd_YzMyYjYwOWYwODE2NWUyZGM5NjE2Zjk5($_REQUEST['user_id']); if (empty($partner_data)) { return [CONTROLLER_STATUS_NO_PAGE]; } $partner_data['total_payouts'] = db_get_field( 'SELECT SUM(amount)' . ' FROM ?:affiliate_payouts' . ' WHERE partner_id = ?i', $_REQUEST['user_id'] ); list($last_payouts, $max_amount) = sd_ZjdhMzFhYzQ0OTM1YmFkYWZjNzM2MGE4($_REQUEST['user_id']); $partners = sd_MjBkMzkzYTA5MzY4NGJiNDAwZTk4YjE4($_REQUEST['user_id']); $plan_list_params = !isset($partner_data['company_id']) ? [] : ['company_id' => $partner_data['company_id']]; $usergroup_for_affiliate['usergroup_id'] = (int) Settings::instance()->getValue('affiliates_usergroup', 'sd_affiliate', 0); if (!empty($usergroup_for_affiliate['usergroup_id'])) { $usergroup_for_affiliate['usergroup'] = fn_get_usergroup_name($usergroup_for_affiliate['usergroup_id']); } Tygh::$app['view']->assign([ 'total_commissions' => sd_ODRhYmU5NTZiMDA4OWRmODM2OWE0MDEx($_REQUEST['user_id']), 'max_amount' => $max_amount, 'last_payouts' => $last_payouts, 'partner' => $partner_data, 'partners' => $partners, 'affiliate_plans' => sd_ODJhMjFlOTZhMDc4YWEwMWRkODE2OTcx(DESCR_SL, $plan_list_params), 'all_affiliates' => sd_MjU4ZmEyNDMwOWE1OGZhMzVlMTU1NzVl($_REQUEST['user_id']), 'usergroup_for_affiliate' => $usergroup_for_affiliate ]); $use_multiple_promotions = Registry::get("addons.sd_affiliate.use_multiple_promotions"); if ($use_multiple_promotions == 'N') { Tygh::$app['view']->assign('coupon_code_list', sd_ZTMyNGUyZTUwZDdhZmE4ODQzNTFmNGY4($_REQUEST['user_id'])); } } } 