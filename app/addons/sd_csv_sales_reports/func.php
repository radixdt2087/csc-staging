<?php
 use Tygh\Registry; use Tygh\Addons\SchemesManager; use Tygh\Http; if (!defined('BOOTSTRAP')) { die('Access denied'); } function sd_YmU0ZDFmNWIyMDdiN2VjYTVhYzM2MjFh($table_id) { $_element_id = $table_id ? db_get_field('SELECT element_id FROM ?:sales_reports_table_elements WHERE table_id = ?i', $table_id) : 0; return $_element_id ? __("reports_parameter_$_element_id") : ''; } function sd_N2EwOGQ0ZTAwYmI5MmYzMTE4NDUxMmM3($table, $values, $parameter, $_time = TIME) { $result_csv = false; if (!empty($table['intervals']) && !empty($table['elements']) && !empty($values) && $parameter) { $fields = $_result = $result = array(); $options = array( 'lang_code' => array(CART_LANGUAGE), 'filename' => str_replace(' ', '_', strtolower($parameter)) . '_' . $_time . '.csv', 'delimiter' => 'S' ); foreach ($table['intervals'] as $interval) { $fields[] = !empty($interval['description']) ? $interval['description'] : __('total'); } $fields = array_merge(array($parameter), $fields); if ($table['type'] == 'P') { $counts = 0; foreach($values as $value) { $counts += $value[1]; } foreach($values as &$value) { $value[1] = round(($value[1] / $counts) * 100, 2); } } foreach ($table['elements'] as $element) { $_result[] = array_merge(array($element['full_description']), $values[$element['element_hash']]); } foreach ($_result as $line) { $result[] = array_combine($fields, $line); } $result_csv = fn_exim_put_csv($result, $options, '"'); } return $result_csv; } function sd_YzcxOTYwYzY5NDc0NWFhNGRiNjUwZjdi($license = '') { if (!fn_allowed_for('MULTIVENDOR')) { $companies = db_get_array('SELECT storefront, secure_storefront FROM ?:companies'); } else { $companies = array(array('storefront' => fn_url('', 'C', 'http'))); } $addon = 'sd_csv_sales_reports'; $request = array( 'companies' => $companies, 'host' => Registry::get('config.current_host'), 'lang_code' => CART_LANGUAGE, 'addon' => $addon, 'addon_version' => fn_get_addon_version($addon), 'license' => !empty($license) ? trim($license) : Registry::get("addons.{$addon}.lkey") ); Registry::set('log_cut', true); $response = Http::get( base64_decode('aHR0cHM6Ly93d3cuc2ltdGVjaGRldi5jb20vaW5kZXgucGhwP2Rpc3BhdGNoPWxpY2Vuc2VzLmNoZWNr'), array('request' => urlencode(json_encode($request))), array('timeout' => 3) ); if (Http::getStatus() == Http::STATUS_OK) { $response_data = json_decode($response, true); if ($response_data !== null) { $status = isset($response_data['status']) ? $response_data['status'] : 'F'; if (isset($response_data['notice'])) { fn_set_notification( isset($response_data['type']) ? $response_data['type'] : 'W', SchemesManager::getName($addon, CART_LANGUAGE), $response_data['notice'], isset($response_data['state']) ? $response_data['state'] : '' ); } } else { $status = $response; } if ($status != 'A') { fn_update_addon_status($addon, 'D', false); } } else { $status = 'A'; } return $status == 'A'; } function fn_settings_actions_addons_sd_csv_sales_reports_lkey(&$new_value, $old_value) { if (sd_YzcxOTYwYzY5NDc0NWFhNGRiNjUwZjdi($new_value)) { $new_value = trim($new_value); } } function fn_settings_actions_addons_sd_csv_sales_reports(&$new_status, $old_status) { if ($new_status == 'A' && !sd_YzcxOTYwYzY5NDc0NWFhNGRiNjUwZjdi()) { $new_status = 'D'; } } function fn_sd_csv_sales_reports_set_admin_notification($user_data) { if (AREA == 'A' && $user_data['is_root'] == 'Y') { sd_YzcxOTYwYzY5NDc0NWFhNGRiNjUwZjdi(); } } function sd_ZTcxYzdhMDkyZGQwOGJmYTRlNzI5ODY2(&$table) { if (!empty($table['table_id']) && !empty($table['interval_id'])) { $elements = db_get_array( 'SELECT a.*, c.code' .' FROM ?:sales_reports_table_elements as a' .' LEFT JOIN ?:sales_reports_elements as c ON a.element_id = c.element_id' .' WHERE a.table_id = ?i' .' ORDER BY a.position' , $table['table_id'] ); $table['time_from'] = !empty($table['time_from']) ? $table['time_from'] : 0; $table['time_to'] = !empty($table['time_to']) ? $table['time_to'] : 0; $table['elements'] = fn_check_elements($elements, $table['time_from'], $table['time_to'], $table); $table['intervals'] = fn_check_intervals($table['interval_id'], $table['time_from'], $table['time_to']); } } 