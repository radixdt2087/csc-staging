<?php
 use Tygh\Registry; use Tygh\GoogleAuth\GoogleAuth; if (!defined('BOOTSTRAP')) { die('Access denied'); } if ($_SERVER['REQUEST_METHOD'] == 'POST') { if ($mode == 'update') { if (!empty($_REQUEST['user_data']['two_steps_auth_code'])) { if (isset(Tygh::$app['session']['auth_secret_code'])) { $secret = Tygh::$app['session']['auth_secret_code']; if (fn_sd_google_authenticator_check_auth_code($_REQUEST['user_data']['two_steps_auth_code'], $secret)) { $result = fn_sd_google_authenticator_save_secret_key($auth['user_id'], $secret); if ($result) { fn_set_notification('N', __('notice'), __('your_secret_code_has_been_saved')); } unset(Tygh::$app['session']['auth_secret_code']); } else { fn_set_notification('E', __('error'), __('entered_code_is_invalid')); } } else { fn_set_notification('E', __('error'), __('error_occured_during_secret_code_saving')); } } } return; } if ($mode == 'update') { if (!empty($_REQUEST['user_id'])) { $is_current_user = $auth['user_id'] == $_REQUEST['user_id']; if (($is_current_user || $auth['is_root'] == 'Y') && fn_sd_google_authenticator_is_allow_auth($_REQUEST['user_id']) ) { $show_two_steps_verification_tab = Registry::get('settings.Security.two_steps_verification') == 'Y'; $has_security_code = fn_sd_google_authenticator_check_user_has_security_code($_REQUEST['user_id']); $show_reset_button = $has_security_code; $reset_button_url = $show_reset_button ? fn_url(sprintf('google_authenticator.drop_secret&user_id=%s', $_REQUEST['user_id']), 'A') : ''; Tygh::$app['view']->assign(array( 'show_two_steps_verification_tab' => $show_two_steps_verification_tab, 'show_reset_button' => $show_reset_button, 'show_barcode' => !$has_security_code && $is_current_user, 'reset_button_url' => $reset_button_url, )); if ($show_two_steps_verification_tab) { Registry::set('navigation.tabs.two_steps_verification', array( 'title' => __('two_steps_verification'), 'js' => true )); if (!$has_security_code && $is_current_user) { $tfa = GoogleAuth::instance(); $secret = $tfa->createSecret(); $user_email = fn_sd_google_authenticator_get_user_email($auth['user_id']); $qr_code_uri = $tfa->getQRCodeImageAsDataUri($user_email, $secret); $string_code = chunk_split($secret, 4, ' '); Tygh::$app['view']->assign(array( 'qr_code_uri' => $qr_code_uri, 'string_code' => $string_code, )); Tygh::$app['session']['auth_secret_code'] = $secret; } } } } } 