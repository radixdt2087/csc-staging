<?php
 use Tygh\Registry; if (!defined('BOOTSTRAP')) { die('Access denied'); } if ($_SERVER['REQUEST_METHOD'] == 'POST') { if ($mode == 'login') { if (AREA == 'A' && Registry::get('settings.Security.two_steps_verification') == 'Y' && !empty($auth['user_id']) ) { $auth['auth_code_required'] = false; $cookie = fn_get_cookie(VERIFICATION_HASH); $has_secret_code = fn_sd_google_authenticator_has_secret_code($auth['user_id']); $verification_hash = fn_sd_google_authenticator_get_verification_hash($auth['user_id']); fn_sd_google_authenticator_update_verification_hash($auth['user_id']); if ($has_secret_code && (empty($verification_hash) || !in_array($cookie, $verification_hash))) { $auth['auth_code_required'] = true; $entry_point = fn_sd_google_authenticator_get_admin_area_entry_point($auth); $return_url = !empty($_REQUEST['return_url']) ? $_REQUEST['return_url'] : $entry_point; return array(CONTROLLER_STATUS_REDIRECT, "{$entry_point}?dispatch=google_authenticator.login&return_url={$return_url}"); } elseif ($has_secret_code && $cookie == $verification_hash) { fn_sd_google_authenticator_set_verification_hash($auth['user_id']); } } } return; } 