<?php
 if (!defined('BOOTSTRAP')) { die('Access denied'); } use Tygh\Registry; if ($_SERVER['REQUEST_METHOD'] == 'POST') { if ($mode == 'login') { $redirect_to_gauth_page = true; if (!empty($_REQUEST['authentication_code'])) { $two_steps_auth_secret = fn_sd_google_authenticator_get_user_secret_code($auth['user_id']); $is_code_valid = fn_sd_google_authenticator_check_auth_code($_REQUEST['authentication_code'], $two_steps_auth_secret); if ($two_steps_auth_secret && !$is_code_valid) { fn_set_notification('E', __('error'), __('entered_code_is_invalid')); } else { $redirect_to_gauth_page = false; } } else { fn_set_notification('E', __('error'), __('authentication_code_cannot_be_empty')); } $entry_point = fn_sd_google_authenticator_get_admin_area_entry_point($auth); $return_url = !empty($_REQUEST['return_url']) ? $_REQUEST['return_url'] : $entry_point; if (!$redirect_to_gauth_page && !empty($_REQUEST['remember_device']) && $_REQUEST['remember_device'] == 'Y') { fn_sd_google_authenticator_set_verification_hash($auth['user_id']); } if ($redirect_to_gauth_page) { $redirect_url = "{$entry_point}?dispatch=google_authenticator.login&return_url={$return_url}"; } else { unset($auth['auth_code_required']); $redirect_url = fn_url($return_url); } return array(CONTROLLER_STATUS_REDIRECT, $redirect_url); } return; } if ($mode == 'drop_secret') { if (!empty($_REQUEST['user_id']) && ($_REQUEST['user_id'] == $auth['user_id'] || $auth['is_root'] == 'Y') ) { if (fn_sd_google_authenticator_drop_user_secret_code($_REQUEST['user_id'])) { fn_set_notification('N', __('notice'), __('secret_code_dropped')); } else { fn_set_notification('E', __('error'), __('error_occured')); } return array(CONTROLLER_STATUS_REDIRECT, sprintf('profiles.update&user_id=%s&selected_section=two_steps_verification', $_REQUEST['user_id'])); } } elseif ($mode == 'login') { Tygh::$app['view']->assign('view_mode', 'simple'); } 